#!/usr/bin/lua

--[[ urot13.lua

A unicode-aware rot13 implementation.

last update: 2019-02-09

--]]

local u = require 'lunicode'

-- Mapping from unicode code point to decomposition into base character
-- and combining diacritics.
local DECOMPS = { 
    [192] = { 65, 768, },
    [193] = { 65, 769, },
    [194] = { 65, 770, },
    [195] = { 65, 771, },
    [196] = { 65, 776, },
    [197] = { 65, 778, },
    [199] = { 67, 807, },
    [200] = { 69, 768, },
    [201] = { 69, 769, },
    [202] = { 69, 770, },
    [203] = { 69, 776, },
    [204] = { 73, 768, },
    [205] = { 73, 769, },
    [206] = { 73, 770, },
    [207] = { 73, 776, },
    [209] = { 78, 771, },
    [210] = { 79, 768, },
    [211] = { 79, 769, },
    [212] = { 79, 770, },
    [213] = { 79, 771, },
    [214] = { 79, 776, },
    [216] = { 79, 822, },
    [217] = { 85, 768, },
    [218] = { 85, 769, },
    [219] = { 85, 770, },
    [220] = { 85, 776, },
    [221] = { 89, 769, },
    [224] = { 97, 768, },
    [225] = { 97, 769, },
    [226] = { 97, 770, },
    [227] = { 97, 771, },
    [228] = { 97, 776, },
    [229] = { 97, 778, },
    [231] = { 99, 807, },
    [232] = { 101, 768, },
    [233] = { 101, 769, },
    [234] = { 101, 770, },
    [235] = { 101, 776, },
    [236] = { 105, 768, },
    [237] = { 105, 769, },
    [238] = { 105, 770, },
    [239] = { 105, 776, },
    [241] = { 110, 771, },
    [242] = { 111, 768, },
    [243] = { 111, 769, },
    [244] = { 111, 770, },
    [245] = { 111, 771, },
    [246] = { 111, 776, },
    [248] = { 111, 821, },
    [249] = { 117, 768, },
    [250] = { 117, 769, },
    [251] = { 117, 770, },
    [252] = { 117, 776, },
    [253] = { 121, 769, },
    [255] = { 121, 776, },
    [256] = { 65, 772, },
    [257] = { 97, 772, },
    [258] = { 65, 774, },
    [259] = { 97, 774, },
    [260] = { 65, 808, },
    [261] = { 97, 808, },
    [262] = { 67, 769, },
    [263] = { 99, 769, },
    [264] = { 67, 770, },
    [265] = { 99, 770, },
    [266] = { 67, 775, },
    [267] = { 99, 775, },
    [268] = { 67, 780, },
    [269] = { 99, 780, },
    [270] = { 68, 780, },
    [271] = { 100, 780, },
    [272] = { 68, 822, },
    [273] = { 100, 821, },
    [274] = { 69, 772, },
    [275] = { 101, 772, },
    [276] = { 69, 774, },
    [277] = { 101, 774, },
    [278] = { 69, 775, },
    [279] = { 101, 775, },
    [280] = { 69, 808, },
    [281] = { 101, 808, },
    [282] = { 69, 780, },
    [283] = { 101, 780, },
    [284] = { 71, 770, },
    [285] = { 103, 770, },
    [286] = { 71, 774, },
    [287] = { 103, 774, },
    [288] = { 71, 775, },
    [289] = { 103, 775, },
    [290] = { 71, 807, },
    [291] = { 103, 807, },
    [292] = { 72, 770, },
    [293] = { 104, 770, },
    [294] = { 72, 822, },
    [295] = { 104, 821, },
    [296] = { 73, 771, },
    [297] = { 105, 771, },
    [298] = { 73, 772, },
    [299] = { 105, 772, },
    [300] = { 73, 774, },
    [301] = { 105, 774, },
    [302] = { 73, 808, },
    [303] = { 105, 808, },
    [304] = { 73, 775, },
    [308] = { 74, 770, },
    [309] = { 106, 770, },
    [310] = { 75, 807, },
    [311] = { 107, 807, },
    [313] = { 76, 769, },
    [314] = { 108, 769, },
    [315] = { 76, 807, },
    [316] = { 108, 807, },
    [317] = { 76, 780, },
    [318] = { 108, 780, },
    [319] = { 76, },
    [320] = { 108, },
    [321] = { 76, 822, },
    [322] = { 108, 821, },
    [323] = { 78, 769, },
    [324] = { 110, 769, },
    [325] = { 78, 807, },
    [326] = { 110, 807, },
    [327] = { 78, 780, },
    [328] = { 110, 780, },
    [332] = { 79, 772, },
    [333] = { 111, 772, },
    [334] = { 79, 774, },
    [335] = { 111, 774, },
    [336] = { 79, 779, },
    [337] = { 111, 779, },
    [340] = { 82, 769, },
    [341] = { 114, 769, },
    [342] = { 82, 807, },
    [343] = { 114, 807, },
    [344] = { 82, 780, },
    [345] = { 114, 780, },
    [346] = { 83, 769, },
    [347] = { 115, 769, },
    [348] = { 83, 770, },
    [349] = { 115, 770, },
    [350] = { 83, 807, },
    [351] = { 115, 807, },
    [352] = { 83, 780, },
    [353] = { 115, 780, },
    [354] = { 84, 807, },
    [355] = { 116, 807, },
    [356] = { 84, 780, },
    [357] = { 116, 780, },
    [358] = { 84, 822, },
    [359] = { 116, 821, },
    [360] = { 85, 771, },
    [361] = { 117, 771, },
    [362] = { 85, 772, },
    [363] = { 117, 772, },
    [364] = { 85, 774, },
    [365] = { 117, 774, },
    [366] = { 85, 778, },
    [367] = { 117, 778, },
    [368] = { 85, 779, },
    [369] = { 117, 779, },
    [370] = { 85, 808, },
    [371] = { 117, 808, },
    [372] = { 87, 770, },
    [373] = { 119, 770, },
    [374] = { 89, 770, },
    [375] = { 121, 770, },
    [376] = { 89, 776, },
    [377] = { 90, 769, },
    [378] = { 122, 769, },
    [379] = { 90, 775, },
    [380] = { 122, 775, },
    [381] = { 90, 780, },
    [382] = { 122, 780, },
    [384] = { 98, 821, },
    [385] = { 66, 777, },
    [386] = { 66, },
    [387] = { 98, },
    [391] = { 67, 777, },
    [392] = { 99, 777, },
    [394] = { 68, 777, },
    [395] = { 68, },
    [396] = { 100, },
    [401] = { 70, 777, },
    [402] = { 102, 777, },
    [403] = { 71, 777, },
    [407] = { 73, 822, },
    [408] = { 75, 777, },
    [409] = { 107, 777, },
    [410] = { 108, },
    [413] = { 78, },
    [414] = { 110, },
    [415] = { 79, 820, },
    [416] = { 79, 795, },
    [417] = { 111, 795, },
    [420] = { 80, 777, },
    [421] = { 112, 777, },
    [427] = { 116, 801, },
    [428] = { 84, 777, },
    [429] = { 116, 777, },
    [430] = { 84, 802, },
    [431] = { 85, 795, },
    [432] = { 117, 795, },
    [434] = { 86, 777, },
    [435] = { 89, 777, },
    [436] = { 121, 777, },
    [437] = { 90, 822, },
    [438] = { 122, 821, },
    [453] = { 68, },
    [456] = { 76, },
    [459] = { 78, },
    [461] = { 65, 780, },
    [462] = { 97, 780, },
    [463] = { 73, 780, },
    [464] = { 105, 780, },
    [465] = { 79, 780, },
    [466] = { 111, 780, },
    [467] = { 85, 780, },
    [468] = { 117, 780, },
    [469] = { 85, 776, 772, },
    [470] = { 117, 776, 772, },
    [471] = { 85, 776, 769, },
    [472] = { 117, 776, 769, },
    [473] = { 85, 776, 780, },
    [474] = { 117, 776, 780, },
    [475] = { 85, 776, 768, },
    [476] = { 117, 776, 768, },
    [478] = { 65, 776, 772, },
    [479] = { 97, 776, 772, },
    [480] = { 65, 775, 772, },
    [481] = { 97, 775, 772, },
    [484] = { 71, 822, },
    [485] = { 103, 821, },
    [486] = { 71, 780, },
    [487] = { 103, 780, },
    [488] = { 75, 780, },
    [489] = { 107, 780, },
    [490] = { 79, 808, },
    [491] = { 111, 808, },
    [492] = { 79, 808, 772, },
    [493] = { 111, 808, 772, },
    [496] = { 106, 780, },
    [498] = { 68, },
    [500] = { 71, 769, },
    [501] = { 103, 769, },
    [504] = { 78, 768, },
    [505] = { 110, 768, },
    [506] = { 65, 778, 769, },
    [507] = { 97, 778, 769, },
    [510] = { 79, 822, 769, },
    [511] = { 111, 821, 769, },
    [512] = { 65, 783, },
    [513] = { 97, 783, },
    [514] = { 65, 785, },
    [515] = { 97, 785, },
    [516] = { 69, 783, },
    [517] = { 101, 783, },
    [518] = { 69, 785, },
    [519] = { 101, 785, },
    [520] = { 73, 783, },
    [521] = { 105, 783, },
    [522] = { 73, 785, },
    [523] = { 105, 785, },
    [524] = { 79, 783, },
    [525] = { 111, 783, },
    [526] = { 79, 785, },
    [527] = { 111, 785, },
    [528] = { 82, 783, },
    [529] = { 114, 783, },
    [530] = { 82, 785, },
    [531] = { 114, 785, },
    [532] = { 85, 783, },
    [533] = { 117, 783, },
    [534] = { 85, 785, },
    [535] = { 117, 785, },
    [536] = { 83, 806, },
    [537] = { 115, 806, },
    [538] = { 84, 806, },
    [539] = { 116, 806, },
    [542] = { 72, 780, },
    [543] = { 104, 780, },
    [544] = { 78, },
    [545] = { 100, },
    [548] = { 90, 777, },
    [549] = { 122, 777, },
    [550] = { 65, 775, },
    [551] = { 97, 775, },
    [552] = { 69, 807, },
    [553] = { 101, 807, },
    [554] = { 79, 776, 772, },
    [555] = { 111, 776, 772, },
    [556] = { 79, 771, 772, },
    [557] = { 111, 771, 772, },
    [558] = { 79, 775, },
    [559] = { 111, 775, },
    [560] = { 79, 775, 772, },
    [561] = { 111, 775, 772, },
    [562] = { 89, 772, },
    [563] = { 121, 772, },
    [564] = { 108, },
    [565] = { 110, },
    [566] = { 116, },
    [570] = { 65, 822, },
    [571] = { 67, 822, },
    [572] = { 99, 821, },
    [573] = { 76, },
    [574] = { 84, 824, },
    [575] = { 115, },
    [576] = { 122, },
    [579] = { 66, 822, },
    [582] = { 69, 822, },
    [583] = { 101, 821, },
    [584] = { 74, 822, },
    [585] = { 106, 821, },
    [587] = { 113, 802, },
    [588] = { 82, 822, },
    [589] = { 114, 821, },
    [590] = { 89, 822, },
    [591] = { 121, 821, },
    [7680] = { 65, 805, },
    [7681] = { 97, 805, },
    [7682] = { 66, 775, },
    [7683] = { 98, 775, },
    [7684] = { 66, 803, },
    [7685] = { 98, 803, },
    [7686] = { 66, 817, },
    [7687] = { 98, 817, },
    [7688] = { 67, 807, 769, },
    [7689] = { 99, 807, 769, },
    [7690] = { 68, 775, },
    [7691] = { 100, 775, },
    [7692] = { 68, 803, },
    [7693] = { 100, 803, },
    [7694] = { 68, 817, },
    [7695] = { 100, 817, },
    [7696] = { 68, 807, },
    [7697] = { 100, 807, },
    [7698] = { 68, 813, },
    [7699] = { 100, 813, },
    [7700] = { 69, 772, 768, },
    [7701] = { 101, 772, 768, },
    [7702] = { 69, 772, 769, },
    [7703] = { 101, 772, 769, },
    [7704] = { 69, 813, },
    [7705] = { 101, 813, },
    [7706] = { 69, 816, },
    [7707] = { 101, 816, },
    [7708] = { 69, 807, 774, },
    [7709] = { 101, 807, 774, },
    [7710] = { 70, 775, },
    [7711] = { 102, 775, },
    [7712] = { 71, 772, },
    [7713] = { 103, 772, },
    [7714] = { 72, 775, },
    [7715] = { 104, 775, },
    [7716] = { 72, 803, },
    [7717] = { 104, 803, },
    [7718] = { 72, 776, },
    [7719] = { 104, 776, },
    [7720] = { 72, 807, },
    [7721] = { 104, 807, },
    [7722] = { 72, 814, },
    [7723] = { 104, 814, },
    [7724] = { 73, 816, },
    [7725] = { 105, 816, },
    [7726] = { 73, 776, 769, },
    [7727] = { 105, 776, 769, },
    [7728] = { 75, 769, },
    [7729] = { 107, 769, },
    [7730] = { 75, 803, },
    [7731] = { 107, 803, },
    [7732] = { 75, 817, },
    [7733] = { 107, 817, },
    [7734] = { 76, 803, },
    [7735] = { 108, 803, },
    [7736] = { 76, 803, 772, },
    [7737] = { 108, 803, 772, },
    [7738] = { 76, 817, },
    [7739] = { 108, 817, },
    [7740] = { 76, 813, },
    [7741] = { 108, 813, },
    [7742] = { 77, 769, },
    [7743] = { 109, 769, },
    [7744] = { 77, 775, },
    [7745] = { 109, 775, },
    [7746] = { 77, 803, },
    [7747] = { 109, 803, },
    [7748] = { 78, 775, },
    [7749] = { 110, 775, },
    [7750] = { 78, 803, },
    [7751] = { 110, 803, },
    [7752] = { 78, 817, },
    [7753] = { 110, 817, },
    [7754] = { 78, 813, },
    [7755] = { 110, 813, },
    [7756] = { 79, 771, 769, },
    [7757] = { 111, 771, 769, },
    [7758] = { 79, 771, 776, },
    [7759] = { 111, 771, 776, },
    [7760] = { 79, 772, 768, },
    [7761] = { 111, 772, 768, },
    [7762] = { 79, 772, 769, },
    [7763] = { 111, 772, 769, },
    [7764] = { 80, 769, },
    [7765] = { 112, 769, },
    [7766] = { 80, 775, },
    [7767] = { 112, 775, },
    [7768] = { 82, 775, },
    [7769] = { 114, 775, },
    [7770] = { 82, 803, },
    [7771] = { 114, 803, },
    [7772] = { 82, 803, 772, },
    [7773] = { 114, 803, 772, },
    [7774] = { 82, 817, },
    [7775] = { 114, 817, },
    [7776] = { 83, 775, },
    [7777] = { 115, 775, },
    [7778] = { 83, 803, },
    [7779] = { 115, 803, },
    [7780] = { 83, 769, 775, },
    [7781] = { 115, 769, 775, },
    [7782] = { 83, 780, 775, },
    [7783] = { 115, 780, 775, },
    [7784] = { 83, 803, 775, },
    [7785] = { 115, 803, 775, },
    [7786] = { 84, 775, },
    [7787] = { 116, 775, },
    [7788] = { 84, 803, },
    [7789] = { 116, 803, },
    [7790] = { 84, 817, },
    [7791] = { 116, 817, },
    [7792] = { 84, 813, },
    [7793] = { 116, 813, },
    [7794] = { 85, 804, },
    [7795] = { 117, 804, },
    [7796] = { 85, 816, },
    [7797] = { 117, 816, },
    [7798] = { 85, 813, },
    [7799] = { 117, 813, },
    [7800] = { 85, 771, 769, },
    [7801] = { 117, 771, 769, },
    [7802] = { 85, 772, 776, },
    [7803] = { 117, 772, 776, },
    [7804] = { 86, 771, },
    [7805] = { 118, 771, },
    [7806] = { 86, 803, },
    [7807] = { 118, 803, },
    [7808] = { 87, 768, },
    [7809] = { 119, 768, },
    [7810] = { 87, 769, },
    [7811] = { 119, 769, },
    [7812] = { 87, 776, },
    [7813] = { 119, 776, },
    [7814] = { 87, 775, },
    [7815] = { 119, 775, },
    [7816] = { 87, 803, },
    [7817] = { 119, 803, },
    [7818] = { 88, 775, },
    [7819] = { 120, 775, },
    [7820] = { 88, 776, },
    [7821] = { 120, 776, },
    [7822] = { 89, 775, },
    [7823] = { 121, 775, },
    [7824] = { 90, 770, },
    [7825] = { 122, 770, },
    [7826] = { 90, 803, },
    [7827] = { 122, 803, },
    [7828] = { 90, 817, },
    [7829] = { 122, 817, },
    [7830] = { 104, 817, },
    [7831] = { 116, 776, },
    [7832] = { 119, 778, },
    [7833] = { 121, 778, },
    [7834] = { 97, 855, },
    [7840] = { 65, 803, },
    [7841] = { 97, 803, },
    [7842] = { 65, 777, },
    [7843] = { 97, 777, },
    [7844] = { 65, 770, 769, },
    [7845] = { 97, 770, 769, },
    [7846] = { 65, 770, 768, },
    [7847] = { 97, 770, 768, },
    [7848] = { 65, 770, 777, },
    [7849] = { 97, 770, 777, },
    [7850] = { 65, 770, 771, },
    [7851] = { 97, 770, 771, },
    [7852] = { 65, 770, 803, },
    [7853] = { 97, 770, 803, },
    [7854] = { 65, 774, 769, },
    [7855] = { 97, 774, 769, },
    [7856] = { 65, 774, 768, },
    [7857] = { 97, 774, 768, },
    [7858] = { 65, 774, 777, },
    [7859] = { 97, 774, 777, },
    [7860] = { 65, 774, 771, },
    [7861] = { 97, 774, 771, },
    [7862] = { 65, 774, 803, },
    [7863] = { 97, 774, 803, },
    [7864] = { 69, 803, },
    [7865] = { 101, 803, },
    [7866] = { 69, 777, },
    [7867] = { 101, 777, },
    [7868] = { 69, 771, },
    [7869] = { 101, 771, },
    [7870] = { 69, 770, 769, },
    [7871] = { 101, 770, 769, },
    [7872] = { 69, 770, 768, },
    [7873] = { 101, 770, 768, },
    [7874] = { 69, 770, 777, },
    [7875] = { 101, 770, 777, },
    [7876] = { 69, 770, 771, },
    [7877] = { 101, 770, 771, },
    [7878] = { 69, 770, 803, },
    [7879] = { 101, 770, 803, },
    [7880] = { 73, 777, },
    [7881] = { 105, 777, },
    [7882] = { 73, 803, },
    [7883] = { 105, 803, },
    [7884] = { 79, 803, },
    [7885] = { 111, 803, },
    [7886] = { 79, 777, },
    [7887] = { 111, 777, },
    [7888] = { 79, 770, 769, },
    [7889] = { 111, 770, 769, },
    [7890] = { 79, 770, 768, },
    [7891] = { 111, 770, 768, },
    [7892] = { 79, 770, 777, },
    [7893] = { 111, 770, 777, },
    [7894] = { 79, 770, 771, },
    [7895] = { 111, 770, 771, },
    [7896] = { 79, 770, 803, },
    [7897] = { 111, 770, 803, },
    [7898] = { 79, 795, 769, },
    [7899] = { 111, 795, 769, },
    [7900] = { 79, 795, 768, },
    [7901] = { 111, 795, 768, },
    [7902] = { 79, 795, 777, },
    [7903] = { 111, 795, 777, },
    [7904] = { 79, 795, 771, },
    [7905] = { 111, 795, 771, },
    [7906] = { 79, 795, 803, },
    [7907] = { 111, 795, 803, },
    [7908] = { 85, 803, },
    [7909] = { 117, 803, },
    [7910] = { 85, 777, },
    [7911] = { 117, 777, },
    [7912] = { 85, 795, 769, },
    [7913] = { 117, 795, 769, },
    [7914] = { 85, 795, 768, },
    [7915] = { 117, 795, 768, },
    [7916] = { 85, 795, 777, },
    [7917] = { 117, 795, 777, },
    [7918] = { 85, 795, 771, },
    [7919] = { 117, 795, 771, },
    [7920] = { 85, 795, 803, },
    [7921] = { 117, 795, 803, },
    [7922] = { 89, 768, },
    [7923] = { 121, 768, },
    [7924] = { 89, 803, },
    [7925] = { 121, 803, },
    [7926] = { 89, 777, },
    [7927] = { 121, 777, },
    [7928] = { 89, 771, },
    [7929] = { 121, 771, },
    [7934] = { 89, },
    [7935] = { 121, },
}

-- Low ends of ranges of code points that can be rot13'd.
local RANGE_BASES = {
    0x0041,    -- A
    0x0061,    -- a
    0x249c,    -- parenthesized latin small letter a
    0x24b6,    -- circled latin capital letter a
    0x24d0,    -- circled latin small letter a
    0xff21,    -- fullwidth latin capital letter a
    0xff41,    -- fullwidth latin small letter a
    0x1f110,   -- parenthesized latin capital letter a
    0x1f130,   -- squared latin capital letter a
    0x1f150,   -- negative circled latin capital letter a
    0x1f170,   -- negative squared latin capital letter a
    0x1f1e6,   -- regional indicator symbol letter a
}

-- If code point cp is in a rotatable range, return the low code point
-- of that range.
local function find_range_base(cp)
    for _, base in ipairs(RANGE_BASES) do
        if cp < base then
            return 0
        elseif cp < base + 26 then
            return base
        end
    end
    
    return 0
end

-- If code point cp is in a rotatable range, rotate it, otherwise just
-- return it.
local function range_rotate(cp)
    local base = find_range_base(cp)
    if base == 0 then
        return cp
    else
        return base + ((cp - base + 13) % 26)
    end
end

-- Given an array of code points a, decompose all decomposables and rotate
-- all rotatables, and return an array of the modified code points.
local function rot13_array(a)
    local t = {}
    for _, cp in ipairs(a) do
        local decomp = DECOMPS[cp]
        if decomp then
            local cpz = {}
            for _, c in ipairs(decomp) do table.insert(cpz, c) end
            cpz[1] = range_rotate(cpz[1])
            for _, c in ipairs(cpz) do table.insert(t, c) end
        else
            table.insert(t, range_rotate(cp))
        end
    end
    return t
end

-- Read from stdin line by line and do the thing.
local chunk = io.read('*line')
while chunk do
    local line_arr = u.decode(chunk)
    local line_arr = rot13_array(line_arr)
    print(u.encode(line_arr))
    chunk = io.read('*line')
end
